<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Web Socket Test</title>
</head>
<body>
    <script type="text/javascript" src="http://cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
    <script type="text/javascript" src="http://cdn.bootcss.com/jquery-cookie/1.3.1/jquery.cookie.min.js"></script>
    <script type="text/javascript">
        var url = "ws://127.0.0.1:9090";
        var ws = new WebSocket(url);
        var count = 1;
        var type = "display";
        ws.onopen = function (event) {
            alert(decodeURIComponent($.cookie('am_identity')));
            ws.send('verify {"identity": ' + decodeURIComponent($.cookie('am_identity')) + ', "type": "' + type + '"}');
        }
        ws.onclose = function () {
            if (count <= 5) {
                ws = new WebSocket(url);
                count++;
            }
        }

        ws.onmessage = function (event) {
            var json = JSON.parse(event.data);
            switch (json.type) {
                case "welcome": console.log("你的sessionid是：" + json.message); break;
                case "success":
                    {
                        console.log("标识成功为：" + json.message + "，记录cookies");
                        $.cookie('am_identity', encodeURIComponent(json.message));
                        break;
                    }
                case "notice": console.log(json.message); break;
                default: alert("获取的type是：" + json.type + "\n值是：" + json.message);
            }
        }

        ws.onerror = function () {
            alert("报错了");
        }
    </script>
</body>
</html>